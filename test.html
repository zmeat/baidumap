

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
        body, html, #allmap
        {
            width: 100%;
            height: 100%;
            overflow: hidden;
            margin: 0;
            font-family: "微软雅黑";
        }
    </style>
    <script src="http://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=2d91410e115e9d061e1b606f4cce7d1c"></script>
    <link type="text/css" href="http://weui.github.io/weui/weui.css" rel="stylesheet">
    <link type="text/css" href="css/sitemap.css" rel="stylesheet">
    <title>浙江景区地图</title>
</head>
<body>
    <div id="allmap">
    </div>
    <div style="position:fixed;top: 3%;left:85%;">
        <img src="../images/list.png" style="width:80%" onclick="showlevel()" />
    </div>
    <div class="weui_dialog_alert" id="divLevel" style="display:none">
        <div class="weui_mask" onclick="hidelevel()">
        </div>
        <div class="weui_dialog" style="top: 21%; width: 95%;">
            <p style="font-size:16px;color:#333;margin-top:5px;"><strong>地区（当前 <span id="currpro">浙江省</span>）</strong></p>
            <div style="line-height:20px;padding:0 1%;">
                <span style="border-right:1px solid #dadbdd;float: left;margin:5px 0 5px 0;letter-spacing:2px;width:23%" onclick="selecta(this)" value="330000">浙江省</span>
                <span style="border-right:1px solid #dadbdd;float: left;margin:5px 0 5px 0;letter-spacing:2px;width:23%" onclick="selecta(this)" value="330100">杭州市</span>
                <span style="border-right:1px solid #dadbdd;float: left;margin:5px 0 5px 0;letter-spacing:2px;width:23%" onclick="selecta(this)" value="330200">宁波市</span>
                <span style="float: left;margin:5px 0 5px 0;letter-spacing:2px;width:23%" onclick="selecta(this)" value="330300">温州市</span>
                <input id="hidcurrareacode" type="hidden" value="330000" />
                <input id="hidcurrpro" type="hidden" value="浙江省" />
            </div>
            <br />
            <div style="line-height:20px;padding:0 1%;">
                <span style="border-right:1px solid #dadbdd;float: left;margin:5px 0 5px 0;letter-spacing:2px;width:23%" onclick="selecta(this)" value="330400">嘉兴市</span>
                <span style="border-right:1px solid #dadbdd;float: left;margin:5px 0 5px 0;letter-spacing:2px;width:23%" onclick="selecta(this)" value="330500">湖州市</span>
                <span style="border-right:1px solid #dadbdd;float: left;margin:5px 0 5px 0;letter-spacing:2px;width:23%" onclick="selecta(this)" value="330600">绍兴市</span>
                <span style="float: left;margin:5px 0 5px 0;letter-spacing:2px;width:23%" onclick="selecta(this)" value="330700">金华市</span>
            </div>
            <br />
            <div style="line-height:20px;padding:0 1%;">
                <span style="border-right:1px solid #dadbdd;float: left;margin:5px 0 5px 0;letter-spacing:2px;width:23%" onclick="selecta(this)" value="330800">衢州市</span>
                <span style="border-right:1px solid #dadbdd;float: left;margin:5px 0 5px 0;letter-spacing:2px;width:23%" onclick="selecta(this)" value="330900">舟山市</span>
                <span style="border-right:1px solid #dadbdd;float: left;margin:5px 0 5px 0;letter-spacing:2px;width:23%" onclick="selecta(this)" value="331000">台州市</span>
                <span style="float: left;margin:5px 0 5px 0;letter-spacing:2px;width:23%" onclick="selecta(this)" value="331100">丽水市</span>
            </div>
            <br />
            <br />
            <div>
            <p style="font-size:16px;color:#333;margin-top:5px;"><strong id="currlevel">景区等级（当前等级 5A）</strong></p>
            <div style="line-height:20px;padding:0 1%;">
                <span style="border-right:1px solid #dadbdd;float: left;margin:5px 0 5px 0;letter-spacing:2px;width:26%" onclick="selectv(5)">AAAAA</span>
                <span style="border-right:1px solid #dadbdd;float: left;margin:5px 0 5px 0;letter-spacing:2px;width:23%" onclick="selectv(4)">AAAA</span>
                <span style="border-right:1px solid #dadbdd;float: left;margin:5px 0 5px 0;letter-spacing:2px;width:20%" onclick="selectv(3)">AAA</span>
                <span style="border-right:1px solid #dadbdd;float: left;margin:5px 0 5px 0;letter-spacing:2px;width:18%" onclick="selectv(2)">AA</span>
                <span style="float: left;margin:5px 0 5px 0;width:8%" onclick="selectv(1)">A</span>
                <input id="hidlevel" type="hidden" value="5" />
            </div>
            </div>
        </div>
    </div>
    <div class="weui_dialog_alert" id="divalert" style="display:none">
        <div style="z-index: 1;width: 100%;height: 100%;top: 0;left: 0;background: rgba(0, 0, 0, 0.6);">
        </div>
        <div class="weui_dialog" style="top:88%;width:95%">
            <div class="weui_dialog_bd" id="alertNote" onclick="alertUnit()">
                <div class="info-box">
                   <p class="title"><strong id="utitle">西湖风景区</strong></p>
                   <div class="other-info">
                       <span id="udist" class="dist">
                       <i class="dist-icon"></i>3.3km
                       </span>
                       <span id="ulevel" class="spanlevel">AAAAA</span>
                       <input id="hidpoint" type="hidden" />
                       <input id="hidareacode" type="hidden" />
                       <input id="hidunitid" type="hidden" />
                       <input id="hidunitshow" type="hidden" value="0" />
                   </div>
                </div>
                <div class="detail-link">详情
                </div>
            </div>
            <div class="weui_dialog_ft" style="margin-top:10px;left:16px;width:91%;line-height:35px;">
                <a onclick="Navigation()" href="javascript:;" class="weui_btn_dialog primary" style="color:#3b3b3b;font-size:14px;"><span><i class="icon">↱</i>到这去</span></a>
            </div>
        </div>
    </div>
</body>
</html>
<script type="text/javascript">
    var marker1 = [];
    var dpoint;
    var prvmk = null;
    var unitshow = false;
    // 百度地图API功能
    var map = new BMap.Map("allmap");
    var hpoint = new BMap.Point(120.14167, 30.292033);
    map.centerAndZoom(hpoint, 7);

    if ("" != "" && "" != "") {
        var point = new BMap.Point("", "");
        dpoint = point;
        movemap();
    }
    else {
        var geolocation = new BMap.Geolocation();
        geolocation.getCurrentPosition(function (r) {
            if (this.getStatus() == BMAP_STATUS_SUCCESS) {
                dpoint = r.point;
                $.post("WriteCookie.ashx", {
                    lng: r.point.lng,
                    lat: r.point.lat
                }, function (r) {
                })
            }
            else {
                dpoint = hpoint;
            }
            movemap();
        }, { enableHighAccuracy: true })
    }
    var top_right_navigation = new BMap.NavigationControl({ anchor: BMAP_ANCHOR_BOTTOM_RIGHT, type: BMAP_NAVIGATION_CONTROL_ZOOM, offset: new BMap.Size(10, 25) });
    map.addControl(top_right_navigation);

    function movemap() {
        $.ajax({
            url: 'NearSite.ashx',
            type: 'post',
            data: 'lat=' + dpoint.lat + "&lng=" + dpoint.lng,
            dataType: 'json',
            success: function (da) {
                marker1 = [];
                $.each(da, function (i, item) {
                    var json = eval('({unitid:"' + item.AuditUnitID + '",'
					+ 'areacode:"' + item.AreaCode + '",'
                    + 'dj:"' + item.Level + '",'
					+ 'point:"' + item.lng + '|' + item.lat + '",'
					+ 'ulevel:"' + item.LevelNew + '",img:"red.png",unitname:"' + item.UnitName + '",distance:"' + item.d + '"})');
                    marker1.push(json);
                });
                addMarker();
            }
        });
    }

    function addMarker() {
        map.clearOverlays();
        var icon = new BMap.Icon("../images/blue.png", new BMap.Size(23, 35));
        var markerArr = null;
        markerArr = filterlevel(marker1);
        for (var i = 0; i < markerArr.length; i++) {
            var point = new BMap.Point(markerArr[i].point.split("|")[0], markerArr[i].point.split("|")[1]);
            var iconImg = createIcon(markerArr[i].img);
            var marker = new BMap.Marker(point, { icon: iconImg });
            map.addOverlay(marker);
            (function () {
                var _marker = marker;
                _marker.addEventListener("click", function () {
                    unitshow = true;
                    $("#hidunitshow").val("1");
                    if (prvmk != null) {
                        var icon1 = new BMap.Icon("../images/red.png", new BMap.Size(19, 32));
                        prvmk.setIcon(icon1);
                    }
                    _marker.setIcon(icon);
                    for (var j = 0; j < markerArr.length; j++) {
                        if (markerArr[j].point.split("|")[0] == _marker.getPosition().lng && markerArr[j].point.split("|")[1] == _marker.getPosition().lat) {
                            $("#udist").html("<i class=\"dist-icon\"></i>" + markerArr[j].distance);
                            $("#ulevel").text(markerArr[j].ulevel);
                            $("#utitle").text(markerArr[j].unitname);
                            $("#hidpoint").val(markerArr[j].point);
                            $("#hidareacode").val(markerArr[j].areacode);
                            $("#hidunitid").val(markerArr[j].unitid);
                            $("#divalert").show();
                        }
                    }
                    $(".BMap_stdMpCtrl").css("bottom", "25%");
                    prvmk = _marker;
                });
            })()
        }
        if ($("#hidunitshow").val() == "1") {
            unitshow = true;
            var mkrs1 = map.getOverlays();
            for (var i = 0; i < mkrs1.length; i++) {
                if (mkrs1[i].getPosition().lng == $("#hidpoint").val().split("|")[0] && mkrs1[i].getPosition().lat == $("#hidpoint").val().split("|")[1]) {
                    mkrs1[i].setIcon(new BMap.Icon("../images/blue.png", new BMap.Size(23, 35)));
                    prvmk = mkrs1[i];
                }
            }
            var point1 = new BMap.Point($("#hidpoint").val().split("|")[0], $("#hidpoint").val().split("|")[1]);
            var marker2 = new BMap.Marker(point1);
            for (var j = 0; j < markerArr.length; j++) {
                if (markerArr[j].point.split("|")[0] == marker2.getPosition().lng && markerArr[j].point.split("|")[1] == marker2.getPosition().lat) {
                    $("#udist").html("<i class=\"dist-icon\"></i>" + markerArr[j].distance);
                    $("#ulevel").text(markerArr[j].ulevel);
                    $("#utitle").text(markerArr[j].unitname);
                    $("#divalert").show();
                }
            }
            $(".BMap_stdMpCtrl").css("bottom", "25%");
        }
        getBoundary($("#hidcurrpro").val());
    }

    function getBoundary(str) {
        var bdary = new BMap.Boundary();
        bdary.get(str, function (rs) {       //获取行政区域 
            var count = rs.boundaries.length; //行政区域的点有多少个
            var pointArray = [];
            for (var i = 0; i < count; i++) {
                var ply = new BMap.Polygon(rs.boundaries[i], { strokeWeight: 2, strokeColor: "#ff0000", fillOpacity: 0, fillColor: "" }); //建立多边形覆盖物
                map.addOverlay(ply);  //添加覆盖物
                pointArray = pointArray.concat(ply.getPath());
            }
            map.setViewport(pointArray);    //调整视野
        });
    }

    function createIcon(json) {
        var icon = new BMap.Icon("../images/" + json, new BMap.Size(19, 32))
        return icon;
    }

    function Navigation() {
        window.location.href = "http://api.map.baidu.com/direction?origin=latlng:" + dpoint.lat + "," + dpoint.lng
            + "|name:我的位置&destination=latlng:" + $("#hidpoint").val().split('|')[1] + "," + $("#hidpoint").val().split('|')[0]
            + "|name:" + encodeURI($("#utitle").text()) + "&mode=driving&origin_region=" + $("#hidareacode").val()
            + "&destination_region=" + $("#hidareacode").val()
            + "&output=html&src=景区";
    }

    function alertUnit() {
        window.location.href = "InfoGame.aspx?AuditUnitid=" + $("#hidunitid").val();
    }

    function filterlevel(unitlist) {
        $("#currlevel").text("景区等级（当前等级 " + $("#hidlevel").val() + "A）");
        var newunitlist = [];
        var level = $("#hidlevel").val();
        var areacode="";
        if ($("#hidcurrareacode").val() != "330000") {
            areacode = $("#hidcurrareacode").val().substr(0, 4);
        }
        for (var j = 0; j < unitlist.length; j++) {
            if (areacode != "") {
                if (unitlist[j].dj == level && unitlist[j].areacode.substr(0, 4) == areacode) {
                    newunitlist.push(unitlist[j]);
                }
            }
            else {
                if (unitlist[j].dj == level) {
                    newunitlist.push(unitlist[j]);
                }
            }
        }
        return newunitlist;
    }

    function showlevel() {
        $("#divLevel").show();
        if (unitshow) {
            $("#divalert").hide();
        }
    }

    function hidelevel() {
        $("#divLevel").hide();
        if (unitshow) {
            $("#divalert").show();
        }
    }

    function selectv(e) {
        if (e != $("#hidlevel").val()) {
            $("#divLevel").hide();
            unitshow = false;
            $("#hidunitshow").val("0");
            $("#hidlevel").val(e);
            addMarker();
        }
        else {
            $("#divLevel").hide();
        }
    }

    function selecta(e) {
        if ($(e).attr("value") != $("#hidcurrareacode").val()) {
            $("#divLevel").hide();
            unitshow = false;
            $("#hidunitshow").val("0");
            $("#hidcurrareacode").val($(e).attr("value"));
            $("#currpro").text($(e).text());
            $("#hidcurrpro").val($(e).text());
            addMarker();
        }
        else {
            $("#divLevel").hide();
        } 
    }
</script>